name: Badges

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate-coverage-badge:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Set up environment
        uses: ./.github/actions/setup-env

      - name: Run tests with coverage
        run: just coverage

      - name: get coverage percentage
        run : |
          coverage_percent=$(uv run coverage report | tail -n 1 | awk '{print int($4)}')
          echo "COVERAGE_PERCENT=$coverage_percent" >> $GITHUB_ENV

      - name: create badge
        run: |
          percent=${{ env.COVERAGE_PERCENT }}
          # Convert percentage to a color on a red → yellow → green gradient
          # Red = 224,93,68 (#e05d44), Yellow = 223,179,23 (#dfb317), Green = 76,193,1 (#4c1)
          if [ $percent -le 50 ]; then
            # interpolate red → yellow
            r=$((224 + (223-224)*percent/50))
            g=$((93 + (179-93)*percent/50))
            b=$((68 + (23-68)*percent/50))
          else
            # interpolate yellow → green
            r=$((223 + (76-223)*(percent-50)/50))
            g=$((179 + (193-179)*(percent-50)/50))
            b=$((23 + (1-23)*(percent-50)/50))
          fi
          color=$(printf "#%02x%02x%02x" $r $g $b)
          
          mkdir -p coverage-badge
          echo "{\"schemaVersion\":1,\"label\":\"coverage\",\"message\":\"${percent}%\",\"color\":\"${color}\"}" > coverage-badge/coverage.json

      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b
        with:
          path: coverage-badge

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4