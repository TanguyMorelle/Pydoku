name: Badges

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branch:
      - master

jobs:
  build-coverage-badge:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Set up environment
        uses: ./.github/actions/setup-env

      - name: Run tests with coverage
        run: |
          pytest --cov=your_package --cov-report=term

      - name: Extract coverage percentage
        run: |
          COVERAGE=$(coverage report | tail -1 | awk '{print $4}' | sed 's/%//')
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

      - name: Create badge
        run: |
          COLOR="red"
          if [ "$COVERAGE" -ge 80 ]; then COLOR="brightgreen";
          elif [ "$COVERAGE" -ge 60 ]; then COLOR="yellow";
          fi
          
          mkdir -p badges
          echo "{\"schemaVersion\":1,\"label\":\"coverage\",\"message\":\"${COVERAGE}%\",\"color\":\"$COLOR\"}" > badges/coverage.json